<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vokabel-12 — недельный тренажёр</title>
  <meta name="description" content="Ежедневный тренажёр немецких слов: 3 новых + повторение за 1, 3 и 5 дней (всего 12 слов в день). Режим карточек и PWA." />
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#0f172a"/>
  <style>
    :root{
      --bg: #0f172a; --panel: #111827; --card: #0b1221; --muted: #94a3b8; --text: #e5e7eb;
      --accent: #22d3ee; --accent-2:#a78bfa; --ok:#34d399; --warn:#fbbf24; --danger:#fb7185; --chip:#1f2937; --border:#1f2937; --radius:16px;
    }
    html,body{height:100%}
    body{margin:0;background:linear-gradient(135deg,#0b1221,#151a2c 40%,#0f172a);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,"Apple Color Emoji","Segoe UI Emoji")}
    .wrap{max-width:1200px;margin:0 auto;padding:24px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:18px}
    .title{font-size:20px;font-weight:700;letter-spacing:.2px}
    .title span{color:var(--accent)}
    .sub{color:var(--muted);font-size:13px}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .btn{background:#0b1020;border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:12px;cursor:pointer}
    .btn:hover{border-color:#344155}
    .btn.primary{background:linear-gradient(180deg,#111d33,#0b1528);border-color:#2a3b5a}
    .btn.danger{border-color:#7a2433;color:#ffd7dd;background:#2a0f17}
    .btn.small{padding:6px 10px;font-size:13px}
    .badge{background:#0d1b2a;border:1px solid var(--border);padding:4px 8px;border-radius:999px;color:var(--muted);font-size:12px}
    .switch{display:inline-flex;gap:8px;align-items:center}
    .switch input{accent-color:#22d3ee;transform:scale(1.2)}
    .week{display:grid;gap:12px;grid-template-columns:repeat(7,1fr)}
    @media (max-width:1100px){.week{grid-template-columns:repeat(4,1fr)}}
    @media (max-width:820px){.week{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:540px){.week{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,#0b1221,#0a1120);border:1px solid var(--border);border-radius:var(--radius);padding:14px;display:flex;flex-direction:column;gap:10px;box-shadow:0 1px 0 rgba(255,255,255,.03) inset, 0 30px 80px rgba(0,0,0,.35)}
    .card h3{margin:0 0 2px;font-size:15px;font-weight:700;display:flex;justify-content:space-between;align-items:baseline}
    .card h3 small{color:var(--muted);font-weight:500}
    .sect{border:1px dashed #22314a;border-radius:12px;padding:10px}
    .sect h4{margin:0 0 6px;font-size:13px;color:var(--muted);font-weight:700;letter-spacing:.3px}
    .inputs{display:grid;gap:6px}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:6px}
    .inputs input{background:#0f1627;border:1px solid #1e2a42;border-radius:10px;padding:10px 10px;color:var(--text);font-size:14px}
    .inputs input::placeholder{color:#6b7280}
    .list{display:flex;flex-wrap:wrap;gap:6px}
    .chip{background:var(--chip);border:1px solid var(--border);border-radius:12px;padding:8px 10px;font-size:13px;display:inline-flex;gap:8px;align-items:center}
    .chip .term{font-weight:700}
    .chip .tr{opacity:.9}
    .chip.flash .tr{filter:blur(6px)}
    .chip.revealed .tr{filter:none}
    .chip .reveal{border:1px solid #344155;background:#0b1528;padding:2px 6px;border-radius:8px;font-size:12px;cursor:pointer}
    .muted{color:var(--muted)}
    .footer{margin-top:12px;color:var(--muted);font-size:12px}
    .spacer{flex:1}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .random{margin-top:18px;background:linear-gradient(180deg,#0a111f,#0a1223);border:1px solid var(--border);border-radius:var(--radius);padding:14px}
    .random h3{margin:0 0 8px}
    .divider{height:1px;background:linear-gradient(90deg,transparent,#22314a,transparent);margin:8px 0}
    .hint{font-size:12px;color:#9aaac6}
    .kbd{border:1px solid #344155;background:#0b1528;padding:1px 6px;border-radius:6px;font-size:12px}
    a.link{color:var(--accent)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div class="title">Vokabel-12 <span>•</span> 3 новых + повтор 1/3/5</div>
        <div class="sub">Семь дней (пн–вс). 3 новых слова с переводом + повтор из <b>вчера</b>, <b>3</b> и <b>5</b> дней назад. Есть режим карточек (перевод скрывается).</div>
      </div>
      <div class="controls">
        <button class="btn" id="prevWeek">← Неделя</button>
        <span class="badge" id="weekLabel">…</span>
        <button class="btn" id="nextWeek">Неделя →</button>
        <button class="btn" id="goToday">Сегодня</button>
        <span class="spacer"></span>
        <label class="switch"><input type="checkbox" id="flashToggle" /> Режим карточек</label>
        <button class="btn small" id="exportBtn">Экспорт .json</button>
        <label class="btn small" for="importFile">Импорт .json</label>
        <input type="file" id="importFile" accept="application/json" style="display:none" />
        <button class="btn small danger" id="resetAll">Сбросить всё</button>
      </div>
    </header>

    <main>
      <section class="week" id="weekGrid" aria-live="polite"></section>

      <section class="random" id="randomBox">
        <h3>Случайное повторение</h3>
        <div class="row">
          <button class="btn primary" id="shuffleAll">Перемешать</button>
          <span class="badge" id="allCount">0 слов</span>
          <span class="hint">Подсказка: нажми <span class="kbd">R</span> — быстрое перемешивание.</span>
        </div>
        <div class="divider"></div>
        <div class="list" id="randomList"></div>
      </section>

      <div class="footer">Добавь на главный экран. Работает офлайн (PWA). Экспортируй резервную копию время от времени.</div>
    </main>
  </div>

  <script>
    (function(){
      const dayNames = ['Понедельник','Вторник','Среда','Четверг','Пятница','Суббота','Воскресенье'];
      const fmtDate = (d)=> d.toLocaleDateString('ru-RU',{day:'2-digit',month:'2-digit'});
      const iso = (d)=>{
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,'0');
        const da = String(d.getDate()).padStart(2,'0');
        return `${y}-${m}-${da}`;
      }
      const addDays = (d,n)=>{ const x = new Date(d); x.setDate(x.getDate()+n); x.setHours(0,0,0,0); return x; }
      const mondayOf = (d)=>{ const x = new Date(d); const wd = (x.getDay()+6)%7; x.setDate(x.getDate()-wd); x.setHours(0,0,0,0); return x; }

      const el = (q)=>document.querySelector(q);
      const mk = (tag, props={}, ...kids)=>{ const n=document.createElement(tag); Object.assign(n, props); kids.forEach(k=> n.append(k)); return n; }

      const STORAGE_KEY = 'vokabel12_v2'; // схема с переводами
      const LEGACY_KEY = 'vokabel12_v1';

      function migrate(){
        const legacy = localStorage.getItem(LEGACY_KEY);
        if(legacy && !localStorage.getItem(STORAGE_KEY)){
          try{
            const old = JSON.parse(legacy);
            const entries = {};
            for(const [date, arr] of Object.entries(old.entries||{})){
              entries[date] = (arr||[]).map(w=>({w:String(w), t:''})).slice(0,3);
            }
            const reviewed = old.reviewed || {};
            const v2 = { entries, reviewed, flash:false };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(v2));
          }catch(e){ /* ignore */ }
        }
      }
      migrate();

      function loadState(){
        try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || { entries:{}, reviewed:{}, flash:false }; }
        catch(e){ return { entries:{}, reviewed:{}, flash:false }; }
      }
      function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

      let state = loadState();
      let weekStart = mondayOf(new Date());

      function getWords(dateStr){
        const raw = state.entries[dateStr]||[];
        // нормализуем к {w,t}
        return raw.map(x => (typeof x==='string' ? {w:x, t:''} : {w:(x.w||''), t:(x.t||'')})).slice(0,3);
      }
      function setWords(dateStr, arr){ // arr = [{w,t},{w,t},{w,t}]
        state.entries[dateStr] = arr.map(p=>({w:(p.w||'').trim(), t:(p.t||'').trim()})).filter(p=>p.w || p.t).slice(0,3);
        saveState();
      }

      function getReviewed(dateStr, offsetKey){ return ((state.reviewed[dateStr]||{})[offsetKey]||[false,false,false]).slice(0,3); }
      function setReviewed(dateStr, offsetKey, idx, val){
        if(!state.reviewed[dateStr]) state.reviewed[dateStr] = {};
        if(!state.reviewed[dateStr][offsetKey]) state.reviewed[dateStr][offsetKey] = [false,false,false];
        state.reviewed[dateStr][offsetKey][idx]=val; saveState();
      }

      function weekLabel(){
        const a = fmtDate(weekStart);
        const b = fmtDate(addDays(weekStart,6));
        return `${a} – ${b}`;
      }

      function renderWeek(){
        el('#weekLabel').textContent = weekLabel();
        el('#flashToggle').checked = !!state.flash;
        const grid = el('#weekGrid');
        grid.innerHTML='';

        for(let i=0;i<7;i++){
          const d = addDays(weekStart,i);
          const dateStr = iso(d);
          const dayTitle = `${dayNames[i]} · ${fmtDate(d)}`;

          const card = mk('div',{className:'card', dataset:{date:dateStr}});
          const h = mk('h3',{}, mk('span',{textContent:dayTitle}), mk('small',{textContent:"12 слов"}));
          card.append(h);

          // Новые слова (3) с переводами
          const news = mk('div',{className:'sect'});
          news.append(mk('h4',{textContent:'Новые 3 слова (слово + перевод)'}));
          const inputs = mk('div',{className:'inputs'});
          const current = getWords(dateStr);
          const rows = [0,1,2].map(idx=>{
            const pair = current[idx] || {w:'',t:''};
            const row = mk('div',{className:'row2'});
            const w = mk('input',{type:'text', placeholder:`Слово ${idx+1}`, value: pair.w || ''});
            const t = mk('input',{type:'text', placeholder:'Перевод/заметка', value: pair.t || ''});
            function persist(){
              const vals = Array.from(inputs.querySelectorAll('.row2')).map(row => {
                const ins = row.querySelectorAll('input');
                return { w: ins[0].value, t: ins[1].value };
              });
              setWords(dateStr, vals);
              renderRandom();
              renderWeek();
            }
            w.addEventListener('change', persist); w.addEventListener('blur', persist);
            t.addEventListener('change', persist); t.addEventListener('blur', persist);
            w.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.currentTarget.blur(); }});
            t.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.currentTarget.blur(); }});
            row.append(w,t);
            return row;
          });
          rows.forEach(r=>inputs.append(r));
          news.append(inputs);
          const clrRow = mk('div',{className:'row'});
          const clearBtn = mk('button',{className:'btn small', textContent:'Очистить день'});
          clearBtn.addEventListener('click', ()=>{ setWords(dateStr, []); renderWeek(); renderRandom(); });
          const countBadge = mk('span',{className:'badge', textContent:`${getWords(dateStr).filter(p=>p.w||p.t).length}/3`});
          const hint = mk('span',{className:'hint', innerHTML:'Ввод сохраняется автоматически.'});
          clrRow.append(clearBtn, countBadge, hint);
          news.append(clrRow);
          card.append(news);

          // Повторения: -1, -3, -5
          [[-1,'Вчера'],[-3,'3 дня назад'],[-5,'5 дней назад']].forEach(([off, label])=>{
            const srcDate = addDays(d,off);
            const srcISO = iso(srcDate);
            const words = getWords(srcISO);
            const offsetKey = `o${off}`;

            const sect = mk('div',{className:'sect'});
            sect.append(mk('h4',{innerHTML:`Повторение: <b>${label}</b> <span class="muted">(${fmtDate(srcDate)})</span>`}));

            const list = mk('div',{className:'list'});
            if(words.length===0){ list.append(mk('span',{className:'muted', textContent:'Нет данных'})); }
            words.forEach((p,idx)=>{
              const checked = getReviewed(dateStr, offsetKey)[idx]===true;
              const chip = mk('span',{className:'chip'+(state.flash?' flash':''), tabIndex:0});
              const term = mk('span',{className:'term', textContent:p.w || '…'});
              const tr = mk('span',{className:'tr', textContent:p.t ? '— '+p.t : '— (нет перевода)'});
              const revBtn = mk('span',{className:'reveal', textContent: state.flash ? 'Показать' : '✓'});
              if(!state.flash) tr.classList.remove('tr');
              if(!state.flash) chip.classList.remove('flash');
              if(checked){ chip.style.opacity = .7; }
              function toggleCheck(){
                if(state.flash){
                  chip.classList.toggle('revealed');
                  revBtn.textContent = chip.classList.contains('revealed') ? 'Скрыть' : 'Показать';
                } else {
                  setReviewed(dateStr, offsetKey, idx, !checked);
                  renderWeek();
                }
              }
              revBtn.addEventListener('click', toggleCheck);
              chip.append(term,tr,revBtn);
              list.append(chip);
            });
            sect.append(list);
            card.append(sect);
          });

          grid.append(card);
        }
      }

      function allPairs(){
        const arr = [];
        Object.values(state.entries).forEach(pairs=> pairs.forEach(p=>{
          if(!p) return;
          const pair = (typeof p==='string') ? {w:p, t:''} : {w:(p.w||''), t:(p.t||'')};
          if(pair.w || pair.t) arr.push(pair);
        }));
        return arr;
      }

      function shuffle(array){
        for(let i=array.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [array[i],array[j]]=[array[j],array[i]]; }
        return array;
      }

      function renderRandom(){
        const list = el('#randomList');
        list.innerHTML='';
        const items = shuffle(allPairs().slice());
        el('#allCount').textContent = `${items.length} пар(ы)`;
        if(items.length===0){ list.append(mk('span',{className:'muted', textContent:'Пока нет слов. Добавь новые в днях недели.'})); return; }
        items.forEach(p=>{
          const chip = mk('span',{className:'chip'+(state.flash?' flash':''), tabIndex:0});
          const term = mk('span',{className:'term', textContent:p.w || '…'});
          const tr = mk('span',{className:'tr', textContent:p.t ? '— '+p.t : '— (нет перевода)'});
          const revBtn = mk('span',{className:'reveal', textContent: state.flash ? 'Показать' : '—'});
          if(!state.flash) tr.classList.remove('tr');
          if(!state.flash) chip.classList.remove('flash');
          function toggle(){ chip.classList.toggle('revealed'); revBtn.textContent = chip.classList.contains('revealed') ? 'Скрыть' : 'Показать'; }
          revBtn.addEventListener('click', toggle);
          chip.append(term,tr,revBtn);
          list.append(chip);
        });
      }

      // Контролы
      document.addEventListener('DOMContentLoaded', ()=>{
        if('serviceWorker' in navigator){
          navigator.serviceWorker.register('./sw.js').catch(()=>{});
        }
      });
      el('#prevWeek').addEventListener('click', ()=>{ weekStart = addDays(weekStart,-7); renderWeek(); });
      el('#nextWeek').addEventListener('click', ()=>{ weekStart = addDays(weekStart, 7); renderWeek(); });
      el('#goToday').addEventListener('click', ()=>{ weekStart = mondayOf(new Date()); renderWeek(); });
      el('#shuffleAll').addEventListener('click', renderRandom);
      el('#flashToggle').addEventListener('change', (e)=>{ state.flash = !!e.target.checked; saveState(); renderWeek(); renderRandom(); });
      document.addEventListener('keydown', (e)=>{ if(e.key==='r' || e.key==='R'){ renderRandom(); }});

      // Экспорт / Импорт / Сброс
      el('#exportBtn').addEventListener('click', ()=>{
        const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'vokabel12_backup_'+ new Date().toISOString().slice(0,10) + '.json';
        document.body.appendChild(a); a.click(); a.remove();
        setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
      });
      el('#importFile').addEventListener('change', (ev)=>{
        const file = ev.target.files && ev.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = ()=>{
          try{
            const data = JSON.parse(reader.result);
            if(!data || typeof data!=='object') throw new Error('Bad JSON');
            if(!data.entries) data.entries={};
            if(!data.reviewed) data.reviewed={};
            if(typeof data.flash!=='boolean') data.flash=false;
            state = { entries:data.entries, reviewed:data.reviewed, flash:data.flash };
            saveState();
            renderWeek(); renderRandom();
            alert('Импортировано успешно.');
          }catch(err){ alert('Ошибка импорта: '+ err.message); }
          finally{ ev.target.value=''; }
        };
        reader.readAsText(file);
      });
      el('#resetAll').addEventListener('click', ()=>{
        if(confirm('Точно удалить все данные? Отменить будет невозможно.')){
          state = { entries:{}, reviewed:{}, flash:false };
          saveState();
          renderWeek(); renderRandom();
        }
      });

      // Первый рендер
      renderWeek();
      renderRandom();
    })();
  </script>
</body>
</html>
